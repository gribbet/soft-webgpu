(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))g(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&g(s)}).observe(document,{childList:!0,subtree:!0});function I(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function g(t){if(t.ep)return;t.ep=!0;const a=I(t);fetch(t.href,a)}})();const K=64,F=8,B=(e,o,I)=>{const g=e.createBuffer({size:I.byteLength,usage:o|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),t=I instanceof Uint32Array?Uint32Array:Float32Array;return new t(g.getMappedRange()).set(I),g.unmap(),g},w=(e,o,I)=>e.createBindGroup({layout:o.getBindGroupLayout(0),entries:I.map((g,t)=>({binding:t,resource:{buffer:g}}))}),R=.1,k=.75,M=.0125,Z=Math.floor(R/M),J=Math.floor(k/M),u=new Array(J+1).fill(0).flatMap((e,o)=>new Array(Z+1).fill(0).map((I,g)=>[M*g-o*M/2-R*.5,M*o*Math.sqrt(3)/2-k*.5])),Y=new Array(Z).fill(0).flatMap((e,o)=>new Array(J).fill(0).flatMap((I,g)=>[[g*(Z+1)+o,g*(Z+1)+o+1,(g+1)*(Z+1)+o+1],[g*(Z+1)+o,(g+1)*(Z+1)+o+1,(g+1)*(Z+1)+o]])),j=e=>new Array(4).fill(0).map((o,I,{length:g})=>{const t=e/2e3+2*(I*Math.PI)/g;return{normal:[Math.cos(t),Math.sin(t)],offset:-.5}}),Q=async({device:e,positionBuffer:o,previousBuffer:I,boundaryBuffer:g})=>{const t=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjxzdG9yYWdlLCByZWFkPiBib3VuZGFyaWVzOiBhcnJheTxCb3VuZGFyeT47IApAZ3JvdXAoMCkgQGJpbmRpbmcoMSkgdmFyPHN0b3JhZ2UsIHJlYWRfd3JpdGU+IHBvc2l0aW9uczogYXJyYXk8dmVjMjxmMzI+PjsKQGdyb3VwKDApIEBiaW5kaW5nKDIpIHZhcjxzdG9yYWdlLCByZWFkX3dyaXRlPiBwcmV2aW91c2VzOiBhcnJheTx2ZWMyPGYzMj4+OwoKY29uc3QgZnJpY3Rpb24gPSAwLjU7CgpzdHJ1Y3QgQm91bmRhcnkgewogICAgbm9ybWFsOiB2ZWMyPGYzMj4sCiAgICBvZmZzZXQ6IGYzMgp9OwoKQGNvbXB1dGUgQHdvcmtncm91cF9zaXplKDY0KQpmbiBtYWluKEBidWlsdGluKGdsb2JhbF9pbnZvY2F0aW9uX2lkKSBnbG9iYWxfaWQ6IHZlYzM8dTMyPikgewogICAgbGV0IGkgPSBnbG9iYWxfaWQueDsKCiAgICB2YXIgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICB2YXIgcHJldmlvdXMgPSBwcmV2aW91c2VzW2ldOwoKICAgIGZvciAodmFyIGogPSAwdTsgaiA8IGFycmF5TGVuZ3RoKCZib3VuZGFyaWVzKTsgaisrKSB7CiAgICAgICAgbGV0IGJvdW5kYXJ5ID0gYm91bmRhcmllc1tqXTsKICAgICAgICBsZXQgbm9ybWFsID0gYm91bmRhcnkubm9ybWFsOwogICAgICAgIGxldCBvZmZzZXQgPSBib3VuZGFyeS5vZmZzZXQ7CgogICAgICAgIGxldCBkaXN0YW5jZSA9IGRvdChwb3NpdGlvbiwgbm9ybWFsKSAtIG9mZnNldDsKICAgICAgICBpZiBkaXN0YW5jZSA8IDAgewogICAgICAgICAgICBwb3NpdGlvbiAtPSBkaXN0YW5jZSAqIG5vcm1hbDsKICAgICAgICAgICAgbGV0IHZlbG9jaXR5ID0gcG9zaXRpb24gLSBwcmV2aW91czsKICAgICAgICAgICAgbGV0IG5vcm1hbF92ZWxvY2l0eSA9IGRvdCh2ZWxvY2l0eSwgbm9ybWFsKSAqIG5vcm1hbDsKICAgICAgICAgICAgbGV0IHRhbmdlbnRpYWxfdmVsb2NpdHkgPSB2ZWxvY2l0eSAtIG5vcm1hbF92ZWxvY2l0eTsKICAgICAgICAgICAgbGV0IG5ld192ZWxvY2l0eSA9IC1ub3JtYWxfdmVsb2NpdHkgKyB0YW5nZW50aWFsX3ZlbG9jaXR5ICogKDEuMCAtIGZyaWN0aW9uKTsKICAgICAgICAgICAgcHJldmlvdXMgPSBwb3NpdGlvbiAtIG5ld192ZWxvY2l0eTsKICAgICAgICB9CiAgICB9CgogICAgcG9zaXRpb25zW2ldID0gcG9zaXRpb247CiAgICBwcmV2aW91c2VzW2ldID0gcHJldmlvdXM7Cn0K",import.meta.url))).text()}),a=e.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"main"}}),s=w(e,a,[g,o,I]);return{encode:i=>{const n=i.beginComputePass();n.setPipeline(a),n.setBindGroup(0,s);const r=Math.ceil(u.length/K);n.dispatchWorkgroups(r),n.end()}}},D=K*Math.ceil(u.length/K),X=new Float32Array(D*2);X.set(new Float32Array(u.flat()));const T=new Uint32Array(Y.flat()),L=u.reduce((e,o,I)=>(e[I]=Y.filter(g=>g.includes(I)).map(([g,t,a])=>g===I?[t,a]:t===I?[a,g]:[g,t]),e),{}),h=new Uint32Array(D*F*2);h.fill(4294967295);h.set(u.flatMap((e,o)=>new Array(F).fill(0).flatMap((I,g)=>(L[o]??[])[g]??[4294967295,4294967295])));const H=e=>new Float32Array(e.flatMap(({normal:[o=0,I=0],offset:g})=>[o,I,g,0])),v=async({device:e,deltaBuffer:o,adjacencyBuffer:I,positionBuffer:g,previousBuffer:t,forceBuffer:a})=>{const s=B(e,GPUBufferUsage.STORAGE,X),c=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjx1bmlmb3JtPiBkZWx0YTogZjMyOwpAZ3JvdXAoMCkgQGJpbmRpbmcoMSkgdmFyPHN0b3JhZ2UsIHJlYWQ+IGFkamFjZW5jaWVzOiBhcnJheTxhcnJheTxhcnJheTx1MzIsIDI+LCBuPj47CkBncm91cCgwKSBAYmluZGluZygyKSB2YXI8c3RvcmFnZSwgcmVhZD4gb3JpZ2luYWxzOiBhcnJheTx2ZWMyPGYzMj4+OwpAZ3JvdXAoMCkgQGJpbmRpbmcoMykgdmFyPHN0b3JhZ2UsIHJlYWQ+IHBvc2l0aW9uczogYXJyYXk8dmVjMjxmMzI+PjsKQGdyb3VwKDApIEBiaW5kaW5nKDQpIHZhcjxzdG9yYWdlLCByZWFkPiBwcmV2aW91c2VzOiBhcnJheTx2ZWMyPGYzMj4+OwpAZ3JvdXAoMCkgQGJpbmRpbmcoNSkgdmFyPHN0b3JhZ2UsIHJlYWRfd3JpdGU+IGZvcmNlczogYXJyYXk8dmVjMjxmMzI+PjsKCmNvbnN0IHN0aWZmbmVzcyA9IDEwMC4wOwpjb25zdCBkYW1waW5nID0gMTAwLjA7CmNvbnN0IG4gPSA4dTsKY29uc3QgZXBzaWxvbiA9IDFlLTQ7CiAKY29uc3QgaWRlbnRpdHkgPSBtYXQyeDI8ZjMyPigxLjAsIDAuMCwgMC4wLCAxLjApOwpjb25zdCBpbnZhbGlkID0gbWF0MngyPGYzMj4oKTsKCkBjb21wdXRlIEB3b3JrZ3JvdXBfc2l6ZSg2NCkKZm4gbWFpbihAYnVpbHRpbihnbG9iYWxfaW52b2NhdGlvbl9pZCkgZ2xvYmFsX2lkOiB2ZWMzPHUzMj4pIHsKICAgIGxldCBpID0gZ2xvYmFsX2lkLng7CiAgICBmb3JjZXNbaV0gPSBib2R5X2ZvcmNlcyhpKTs7Cn0KCmZuIGJvZHlfZm9yY2VzKGk6IHUzMikgLT4gdmVjMjxmMzI+IHsKICAgIHZhciBmb3JjZSA9IHZlYzI8ZjMyPigwLCAwKTsKICAgIGxldCBhZGphY2VuY3kgPSBhZGphY2VuY2llc1tpXTsKCiAgICBmb3IgKHZhciB6ID0gMHU7IHogPCBuOyB6KyspIHsKICAgICAgICBsZXQgaiA9IGFkamFjZW5jeVt6XVswXTsKICAgICAgICBsZXQgayA9IGFkamFjZW5jeVt6XVsxXTsKICAgICAgICBpZiAoaiA9PSAweGZmZmZmZmZmKSB7IGJyZWFrOyB9CiAgICAgICAgZm9yY2UgKz0gYm9keV9mb3JjZShpLCBqLCBrKTsKICAgIH0KCiAgICByZXR1cm4gZm9yY2U7Cn0KCmZuIGJvZHlfZm9yY2UoaTogdTMyLCBqOiB1MzIsIGs6IHUzMikgLT4gdmVjMjxmMzI+IHsKICAgIGxldCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgIGxldCBwMSA9IHBvc2l0aW9uc1tqXTsKICAgIGxldCBwMiA9IHBvc2l0aW9uc1trXTsKICAgIAogICAgbGV0IHEwID0gcHJldmlvdXNlc1tpXTsKICAgIGxldCBxMSA9IHByZXZpb3VzZXNbal07CiAgICBsZXQgcTIgPSBwcmV2aW91c2VzW2tdOwoKICAgIGxldCByMCA9IG9yaWdpbmFsc1tpXTsKICAgIGxldCByMSA9IG9yaWdpbmFsc1tqXTsKICAgIGxldCByMiA9IG9yaWdpbmFsc1trXTsKCiAgICBsZXQgZGVmb3JtYXRpb24gPSBtYXQyeDIocDEgLSBwMCwgcDIgLSBwMCkgKiBpbnZlcnNlKG1hdDJ4MihyMSAtIHIwLCByMiAtIHIwKSk7CiAgICB2YXIgc2NhbGVfc2hlYXIgPSBtYXQyeDJfc3FydCh0cmFuc3Bvc2UoZGVmb3JtYXRpb24pICogZGVmb3JtYXRpb24pOwogICAgaWYgaXNfaW52YWxpZChzY2FsZV9zaGVhcikgfHwgaXNfaW52YWxpZChpbnZlcnNlKHNjYWxlX3NoZWFyKSkgewogICAgICAgIHJldHVybiB2ZWMyPGYzMj4oKTsKICAgIH0KICAgIHZhciByb3RhdGlvbiA9IGRlZm9ybWF0aW9uICogaW52ZXJzZShzY2FsZV9zaGVhcik7CiAgICBpZiBkZXRlcm1pbmFudChyb3RhdGlvbikgPCAwLjAgewogICAgICAgIHNjYWxlX3NoZWFyICo9IG1hdDJ4MjxmMzI+KC0xLjAsIDAsIDAsIDEuMCk7CiAgICAgICAgcm90YXRpb24gPSBkZWZvcm1hdGlvbiAqIGludmVyc2Uoc2NhbGVfc2hlYXIpOwogICAgfQoKICAgIGxldCBzdHJhaW4gPSBzY2FsZV9zaGVhciAtIGlkZW50aXR5OwogICAgdmFyIHN0cmVzcyA9IHN0aWZmbmVzcyAqIHN0cmFpbjsKCiAgICBsZXQgdjAgPSAocDAgLSBxMCkgLyBkZWx0YTsKICAgIGxldCB2MSA9IChwMSAtIHExKSAvIGRlbHRhOwogICAgbGV0IHYyID0gKHAyIC0gcTIpIC8gZGVsdGE7CgogICAgbGV0IHN0cmFpbl9yYXRlID0gbWF0MngyPGYzMj4odjEgLSB2MCwgdjIgLSB2MCkgKiBpbnZlcnNlKG1hdDJ4MihyMSAtIHIwLCByMiAtIHIwKSk7CgogICAgcmV0dXJuIChyb3RhdGlvbiAqIHN0cmVzcyAtIChleHAoLWRhbXBpbmcgKiBkZWx0YSkgLSAxLjApICogc3RyYWluX3JhdGUpICogKHIxICsgcjIgLSAyICogcjApOwp9CgpmbiBtYXQyeDJfc3FydChtOiBtYXQyeDI8ZjMyPikgLT4gbWF0MngyPGYzMj4gewogICAgbGV0IHRyYWNlID0gbVswXVswXSArIG1bMV1bMV07CiAgICBsZXQgZGV0ID0gbVswXVswXSAqIG1bMV1bMV0gLSBtWzBdWzFdICogbVsxXVswXTsKICAgIAogICAgbGV0IGRpc2NyaW1pbmFudCA9IHRyYWNlICogdHJhY2UgLSA0LjAgKiBkZXQ7CiAgICBpZiBkaXNjcmltaW5hbnQgPCAwLjAgeyByZXR1cm4gaW52YWxpZDsgfQoKICAgIGxldCBsYW1iZGExID0gMC41ICogKHRyYWNlICsgc3FydChkaXNjcmltaW5hbnQpKTsKICAgIGxldCBsYW1iZGEyID0gMC41ICogKHRyYWNlIC0gc3FydChkaXNjcmltaW5hbnQpKTsKICAgIAogICAgdmFyIHYxID0gdmVjMjxmMzI+KG1bMF1bMF0gLSBsYW1iZGEyLCBtWzBdWzFdKTsKICAgIHZhciB2MiA9IHZlYzI8ZjMyPihtWzBdWzFdLCBtWzFdWzFdIC0gbGFtYmRhMSk7CgogICAgaWYgKGxlbmd0aCh2MSkgPD0gZXBzaWxvbiAmJiBsZW5ndGgodjIpIDw9IGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gaW52YWxpZDsKICAgIH0KICAgIAogICAgaWYgKGxlbmd0aCh2MSkgPiBlcHNpbG9uKSB7CiAgICAgICAgdjEgPSBub3JtYWxpemUodjEpOwogICAgfSBlbHNlIHsKICAgICAgICB2MSA9IHBlcnAobm9ybWFsaXplKHYyKSk7CiAgICB9CiAgICAKICAgIGlmIChsZW5ndGgodjIpID4gZXBzaWxvbikgewogICAgICAgIHYyID0gbm9ybWFsaXplKHYyKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdjIgPSBwZXJwKHYxKTsKICAgIH0KICAgIAogICAgbGV0IHYgPSBtYXQyeDI8ZjMyPih2MSwgdjIpOwogICAgbGV0IGRfc3FydCA9IG1hdDJ4MjxmMzI+KHNxcnQoYWJzKGxhbWJkYTEpKSpzaWduKGxhbWJkYTEpLCAwLjAsIDAuMCwgc3FydChhYnMobGFtYmRhMikpKnNpZ24obGFtYmRhMikpOwogICAgbGV0IHZfaW52ID0gbWF0MngyPGYzMj4odlsxXVsxXSwgLXZbMF1bMV0sIC12WzFdWzBdLCB2WzBdWzBdKSAqICgxLjAgLyAodlswXVswXSAqIHZbMV1bMV0gLSB2WzBdWzFdICogdlsxXVswXSkpOwogICAgcmV0dXJuIHYgKiBkX3NxcnQgKiB2X2ludjsKfQoKZm4gcGVycCh2OiB2ZWMyPGYzMj4pIC0+IHZlYzI8ZjMyPiB7CiAgICByZXR1cm4gdmVjMigtdi55LCB2LngpOwp9CgpmbiBkZXRlcm1pbmFudChtOiBtYXQyeDI8ZjMyPikgLT4gZjMyIHsKICAgIHJldHVybiBtWzBdWzBdICogbVsxXVsxXSAtIG1bMF1bMV0gKiBtWzFdWzBdOwp9CgpmbiBpbnZlcnNlKG06IG1hdDJ4MjxmMzI+KSAtPiBtYXQyeDI8ZjMyPiB7CiAgICBsZXQgZGV0ID0gZGV0ZXJtaW5hbnQobSk7CiAgICBpZiBkZXQgPCBlcHNpbG9uIHsgcmV0dXJuIGludmFsaWQ7IH0KICAgIHJldHVybiBtYXQyeDI8ZjMyPigKICAgICAgICBtWzFdWzFdIC8gZGV0LCAtbVswXVsxXSAvIGRldCwKICAgICAgIC1tWzFdWzBdIC8gZGV0LCAgbVswXVswXSAvIGRldAogICAgKTsKfQoKZm4gaXNfaW52YWxpZChtOiBtYXQyeDI8ZjMyPikgLT4gYm9vbCB7CiAgICByZXR1cm4gaW52YWxpZFswXVswXSA9PSBtWzBdWzBdIAogICAgICAgICYmIGludmFsaWRbMV1bMF0gPT0gbVsxXVswXQogICAgICAgICYmIGludmFsaWRbMF1bMV0gPT0gbVswXVsxXQogICAgICAgICYmIGludmFsaWRbMV1bMV0gPT0gbVsxXVsxXTsKfQ==",import.meta.url))).text()}),i=e.createComputePipeline({layout:"auto",compute:{module:c,entryPoint:"main"}}),n=w(e,i,[o,I,s,g,t,a]);return{encode:A=>{const l=A.beginComputePass();l.setPipeline(i),l.setBindGroup(0,n);const p=Math.ceil(u.length/K);l.dispatchWorkgroups(p),l.end()}}},U=async({device:e,deltaBuffer:o,selectedBuffer:I,anchorBuffer:g,positionBuffer:t,previousBuffer:a,forceBuffer:s})=>{const c=B(e,GPUBufferUsage.UNIFORM,new Float32Array([M])),i=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjx1bmlmb3JtPiBzaXplOiBmMzI7CkBncm91cCgwKSBAYmluZGluZygxKSB2YXI8dW5pZm9ybT4gZGVsdGE6IGYzMjsKQGdyb3VwKDApIEBiaW5kaW5nKDIpIHZhcjx1bmlmb3JtPiBzZWxlY3RlZDogdTMyOwpAZ3JvdXAoMCkgQGJpbmRpbmcoMykgdmFyPHVuaWZvcm0+IGFuY2hvcjogdmVjMjxmMzI+OwpAZ3JvdXAoMCkgQGJpbmRpbmcoNCkgdmFyPHN0b3JhZ2UsIHJlYWRfd3JpdGU+IHBvc2l0aW9uczogYXJyYXk8dmVjMjxmMzI+PjsKQGdyb3VwKDApIEBiaW5kaW5nKDUpIHZhcjxzdG9yYWdlLCByZWFkX3dyaXRlPiBwcmV2aW91c2VzOiBhcnJheTx2ZWMyPGYzMj4+OwpAZ3JvdXAoMCkgQGJpbmRpbmcoNikgdmFyPHN0b3JhZ2UsIHJlYWQ+IGZvcmNlczogYXJyYXk8dmVjMjxmMzI+PjsKCgpjb25zdCBkYW1waW5nID0gMC4wOwpjb25zdCBncmF2aXR5ID0gdmVjMigwLCAtMTAuMCk7CgpAY29tcHV0ZSBAd29ya2dyb3VwX3NpemUoNjQpCmZuIG1haW4oQGJ1aWx0aW4oZ2xvYmFsX2ludm9jYXRpb25faWQpIGdsb2JhbF9pZDogdmVjMzx1MzI+KSB7CiAgICBsZXQgaSA9IGdsb2JhbF9pZC54OwoKICAgIHZhciBjdXJyZW50ID0gcG9zaXRpb25zW2ldOwogICAgbGV0IHByZXZpb3VzID0gcHJldmlvdXNlc1tpXTsKICAgIGxldCBtYXNzID0gc2l6ZSAqIHNpemU7CiAgICBsZXQgZm9yY2UgPSBmb3JjZXNbaV0gKyBncmF2aXR5ICogbWFzczsKICAgIHZhciBwb3NpdGlvbiA9IGN1cnJlbnQgKyBleHAoLWRhbXBpbmcgKiBkZWx0YSkgKiAoY3VycmVudCAtIHByZXZpb3VzKSArIGZvcmNlIC8gbWFzcyAqIGRlbHRhICogZGVsdGE7CgogICAgaWYgaSA9PSBzZWxlY3RlZCB7CiAgICAgICAgcG9zaXRpb24gPSBhbmNob3I7CiAgICAgICAgY3VycmVudCA9IGFuY2hvcjsKICAgIH0KCiAgICBwcmV2aW91c2VzW2ldID0gY3VycmVudDsKICAgIHBvc2l0aW9uc1tpXSA9IHBvc2l0aW9uOwp9Cg==",import.meta.url))).text()}),n=e.createComputePipeline({layout:"auto",compute:{module:i,entryPoint:"main"}}),r=w(e,n,[c,o,I,g,t,a,s]);return{encode:l=>{const p=l.beginComputePass();p.setPipeline(n),p.setBindGroup(0,r);const d=Math.ceil(u.length/K);p.dispatchWorkgroups(d),p.end()}}},S=64,O=async({device:e,selectedBuffer:o,anchorBuffer:I,positionBuffer:g,boundaryBuffer:t})=>{const a=B(e,GPUBufferUsage.UNIFORM,new Float32Array([0])),s=B(e,GPUBufferUsage.STORAGE,h),c=B(e,GPUBufferUsage.STORAGE,X),i=B(e,GPUBufferUsage.STORAGE,X.map(()=>0)),n=d=>e.queue.writeBuffer(a,0,new Float32Array([d])),r=await v({device:e,deltaBuffer:a,adjacencyBuffer:s,positionBuffer:g,previousBuffer:c,forceBuffer:i}),A=await U({device:e,deltaBuffer:a,selectedBuffer:o,anchorBuffer:I,positionBuffer:g,previousBuffer:c,forceBuffer:i}),l=await Q({device:e,positionBuffer:g,previousBuffer:c,boundaryBuffer:t});return{compute:d=>{n(d/S);const b=e.createCommandEncoder();for(let y=0;y<S;y++)r.encode(b),A.encode(b),l.encode(b);e.queue.submit([b.finish()])}}},E=async({device:e,aspectBuffer:o,positionBuffer:I})=>{const g=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjx1bmlmb3JtPiBhc3BlY3Q6IGYzMjsKQGdyb3VwKDApIEBiaW5kaW5nKDEpIHZhcjxzdG9yYWdlLCByZWFkPiBwb3NpdGlvbnM6IGFycmF5PHZlYzI8ZjMyPj47CgpzdHJ1Y3QgT3V0cHV0IHsKICAgIEBidWlsdGluKHBvc2l0aW9uKSBwb3NpdGlvbjogdmVjNDxmMzI+LAogICAgQGxvY2F0aW9uKDApIEBpbnRlcnBvbGF0ZShmbGF0KSBpbmRleDogdTMyLAp9Cgpjb25zdCB2ZXJ0aWNlcyA9IGFycmF5KAogICAgdmVjMjxmMzI+KC0xLCAtMSksIHZlYzI8ZjMyPigxLCAtMSksIHZlYzI8ZjMyPigtMSwgMSksIAogICAgdmVjMjxmMzI+KC0xLCAxKSwgdmVjMjxmMzI+KDEsIC0xKSwgdmVjMjxmMzI+KDEsIDEpCik7CgpAdmVydGV4CmZuIHZlcnRleCgKICAgIEBidWlsdGluKHZlcnRleF9pbmRleCkgdjogdTMyLAogICAgQGJ1aWx0aW4oaW5zdGFuY2VfaW5kZXgpIGk6IHUzMgopIC0+IE91dHB1dCB7CiAgICBsZXQgcG9zaXRpb24gPSAocG9zaXRpb25zW2ldICsgdmVydGljZXNbdl0gKiAwLjAxKSAqIHZlYzIoMS4wLCBhc3BlY3QpOwogICAgcmV0dXJuIE91dHB1dCh2ZWM0KHBvc2l0aW9uLCAwLCAxLjApLCBpKTsKfQoKQGZyYWdtZW50CmZuIGZyYWdtZW50KEBsb2NhdGlvbigwKSBAaW50ZXJwb2xhdGUoZmxhdCkgaW5kZXg6IHUzMikgLT4gQGxvY2F0aW9uKDApIHUzMiB7CiAgICByZXR1cm4gaW5kZXggKyAxOwp9",import.meta.url))).text()}),t=e.createRenderPipeline({layout:"auto",vertex:{module:g,entryPoint:"vertex"},fragment:{module:g,entryPoint:"fragment",targets:[{format:"r32uint"}]}}),a=w(e,t,[o,I]);return{encode:c=>{c.setPipeline(t),c.setBindGroup(0,a),c.draw(6,u.length,0,0)}}},q=async({device:e,aspectBuffer:o,positionBuffer:I})=>{const g=await E({device:e,aspectBuffer:o,positionBuffer:I}),t="r32uint",a=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC;let s=e.createTexture({size:[1,1],format:t,usage:a});return{pick:async([n,r])=>{const A=e.createBuffer({size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),l=e.createCommandEncoder(),p=s.createView(),d=l.beginRenderPass({colorAttachments:[{view:p,loadOp:"clear",storeOp:"store"}]});g.encode(d),d.end(),l.copyTextureToBuffer({texture:s,origin:{x:n,y:r}},{buffer:A},{width:1,height:1,depthOrArrayLayers:1}),e.queue.submit([l.finish()]),await A.mapAsync(GPUMapMode.READ);const[b=0]=new Uint32Array(A.getMappedRange());return A.destroy(),b-1},resize:n=>{s.destroy(),s=e.createTexture({size:n,format:t,usage:a})}}},_=[[-1,-1],[1,-1],[-1,1],[1,1]],$=async({device:e,format:o,aspectBuffer:I,boundaryBuffer:g})=>{const t=B(e,GPUBufferUsage.STORAGE,new Float32Array(_.flat())),a=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjx1bmlmb3JtPiBhc3BlY3Q6IGYzMjsKQGdyb3VwKDApIEBiaW5kaW5nKDEpIHZhcjxzdG9yYWdlLCByZWFkPiBjb3JuZXJzOiBhcnJheTx2ZWMyPGYzMj4+OwpAZ3JvdXAoMCkgQGJpbmRpbmcoMikgdmFyPHN0b3JhZ2UsIHJlYWQ+IGJvdW5kYXJpZXM6IGFycmF5PEJvdW5kYXJ5PjsKCnN0cnVjdCBWZXJ0ZXhPdXRwdXQgewogICAgQGJ1aWx0aW4ocG9zaXRpb24pIGNsaXA6IHZlYzQ8ZjMyPiwKICAgIEBsb2NhdGlvbigwKSBwb3NpdGlvbjogdmVjMjxmMzI+Cn07CgpzdHJ1Y3QgQm91bmRhcnkgewogICAgbm9ybWFsOiB2ZWMyPGYzMj4sCiAgICBvZmZzZXQ6IGYzMgp9OwoKQHZlcnRleApmbiB2ZXJ0ZXgoQGJ1aWx0aW4odmVydGV4X2luZGV4KSBpOiB1MzIpIC0+IFZlcnRleE91dHB1dCB7CiAgICBsZXQgcG9zaXRpb24gPSBjb3JuZXJzW2ldOwogICAgdmFyIG91dHB1dCA9IFZlcnRleE91dHB1dCgpOwogICAgb3V0cHV0LmNsaXAgPSB2ZWM0PGYzMj4ocG9zaXRpb24sIDAuMCwgMS4wKTsKICAgIG91dHB1dC5wb3NpdGlvbiA9IHBvc2l0aW9uIC8gdmVjMigxLjAsIGFzcGVjdCk7CiAgICByZXR1cm4gb3V0cHV0Owp9CgpAZnJhZ21lbnQKZm4gZnJhZ21lbnQoQGxvY2F0aW9uKDApIHBvc2l0aW9uOiB2ZWMyPGYzMj4pIC0+IEBsb2NhdGlvbigwKSB2ZWM0PGYzMj4gewogICAgZm9yICh2YXIgaSA9IDB1OyBpIDwgYXJyYXlMZW5ndGgoJmJvdW5kYXJpZXMpOyBpKyspIHsKICAgICAgICBsZXQgYm91bmRhcnkgPSBib3VuZGFyaWVzW2ldOwogICAgICAgIGxldCBub3JtYWwgPSBib3VuZGFyeS5ub3JtYWw7CiAgICAgICAgbGV0IG9mZnNldCA9IGJvdW5kYXJ5Lm9mZnNldDsKICAgICAgICBsZXQgZGlzdGFuY2UgPSBkb3QocG9zaXRpb24sIG5vcm1hbCkgLSBvZmZzZXQ7CgogICAgICAgIGlmIGRpc3RhbmNlIDwgMCB7CiAgICAgICAgICAgIHJldHVybiB2ZWM0PGYzMj4oMCwgMCwgMCwgMS4wKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdmVjNDxmMzI+KDAuMiwgMC4yLCAwLjIsIDEuMCk7Cn0=",import.meta.url))).text()}),s=e.createRenderPipeline({layout:"auto",vertex:{module:a,entryPoint:"vertex"},fragment:{module:a,entryPoint:"fragment",targets:[{format:o}]},primitive:{topology:"triangle-strip"},multisample:{count:4}}),c=w(e,s,[I,t,g]);return{encode:n=>{n.setPipeline(s),n.setBindGroup(0,c),n.draw(4)}}},ee=async({device:e,format:o,aspectBuffer:I,positionBuffer:g,triangleBuffer:t})=>{const a=e.createShaderModule({code:await(await fetch(new URL("data:text/wgsl;base64,QGdyb3VwKDApIEBiaW5kaW5nKDApIHZhcjx1bmlmb3JtPiBhc3BlY3Q6IGYzMjsKQGdyb3VwKDApIEBiaW5kaW5nKDEpIHZhcjxzdG9yYWdlLCByZWFkPiBwb3NpdGlvbnM6IGFycmF5PHZlYzI8ZjMyPj47CkBncm91cCgwKSBAYmluZGluZygyKSB2YXI8c3RvcmFnZSwgcmVhZD4gdHJpYW5nbGVzOiBhcnJheTxhcnJheTx1MzIsIDM+PjsKCkB2ZXJ0ZXgKZm4gdmVydGV4KAogICAgQGJ1aWx0aW4odmVydGV4X2luZGV4KSB2OiB1MzIsCiAgICBAYnVpbHRpbihpbnN0YW5jZV9pbmRleCkgaTogdTMyCikgLT4gQGJ1aWx0aW4ocG9zaXRpb24pIHZlYzQ8ZjMyPiB7CiAgICByZXR1cm4gdmVjNDxmMzI+KHBvc2l0aW9uc1t0cmlhbmdsZXNbaV1bdl1dICogdmVjMigxLjAsIGFzcGVjdCksIDAuMCwgMS4wKTsKfQoKQGZyYWdtZW50CmZuIGZyYWdtZW50KCkgLT4gQGxvY2F0aW9uKDApIHZlYzQ8ZjMyPiB7CiAgICByZXR1cm4gdmVjNDxmMzI+KDEuMCwgMS4wLCAxLjAsIDEuMCk7Cn0=",import.meta.url))).text()}),s=e.createRenderPipeline({layout:"auto",vertex:{module:a,entryPoint:"vertex"},fragment:{module:a,entryPoint:"fragment",targets:[{format:o}]},multisample:{count:4}}),c=w(e,s,[I,g,t]);return{encode:n=>{n.setPipeline(s),n.setBindGroup(0,c),n.draw(3,Y.length,0,0)}}},ge=async({device:e,context:o,format:I,aspectBuffer:g,boundaryBuffer:t,positionBuffer:a})=>{const s=B(e,GPUBufferUsage.STORAGE,T),c=await $({device:e,format:I,aspectBuffer:g,boundaryBuffer:t}),i=await ee({device:e,format:I,aspectBuffer:g,positionBuffer:a,triangleBuffer:s}),n=GPUTextureUsage.RENDER_ATTACHMENT,r=4;let A=e.createTexture({size:[1,1],sampleCount:r,format:I,usage:n});return{resize:([d,b])=>{A.destroy(),A=e.createTexture({size:[d*devicePixelRatio,b*devicePixelRatio],sampleCount:r,format:I,usage:n})},render:()=>{const d=e.createCommandEncoder(),b=A.createView(),y=o.getCurrentTexture().createView(),W=d.beginRenderPass({colorAttachments:[{view:b,resolveTarget:y,loadOp:"clear",storeOp:"discard"}]});c.encode(W),i.encode(W),W.end(),e.queue.submit([d.finish()])}}},te=async()=>{const{gpu:e}=navigator,o=await e.requestAdapter();if(!o)throw new Error;const I=await o.requestDevice(),{queue:g}=I,t=document.createElement("canvas");document.body.appendChild(t);const a=t.getContext("webgpu");if(!a)throw new Error;const s=e.getPreferredCanvasFormat();a.configure({device:I,format:s});const c=B(I,GPUBufferUsage.UNIFORM,new Float32Array([1])),i=B(I,GPUBufferUsage.UNIFORM,new Uint32Array([-1])),n=B(I,GPUBufferUsage.UNIFORM,new Float32Array([0,0])),r=B(I,GPUBufferUsage.STORAGE,X),A=B(I,GPUBufferUsage.STORAGE,H(j(0))),l=C=>g.writeBuffer(c,0,new Float32Array([C])),p=C=>g.writeBuffer(i,0,new Uint32Array([C])),d=C=>g.writeBuffer(n,0,new Float32Array(C)),b=C=>g.writeBuffer(A,0,H(C)),y=await O({device:I,selectedBuffer:i,anchorBuffer:n,positionBuffer:r,boundaryBuffer:A}),W=await ge({device:I,context:a,format:s,aspectBuffer:c,boundaryBuffer:A,positionBuffer:r}),z=await q({device:I,aspectBuffer:c,positionBuffer:r});new ResizeObserver(([C])=>{const{width:m=0,height:G=0}=(C==null?void 0:C.contentRect)??{};t.width=m*devicePixelRatio,t.height=G*devicePixelRatio,W.resize([m,G]),z.resize([m,G]),l(m/G)}).observe(t);const V=([C,m])=>{const{width:G,height:f}=t,N=G/f;return[2*(C/(G/devicePixelRatio))-1,(1-2*(m/(f/devicePixelRatio)))/N]};t.addEventListener("mousedown",async({x:C,y:m})=>{const G=await z.pick([C,m]);p(G),d(V([C,m]))}),t.addEventListener("mousemove",({x:C,y:m,buttons:G})=>{G!==0&&d(V([C,m]))}),t.addEventListener("mouseup",()=>p(-1));let x;const P=C=>{requestAnimationFrame(P);const m=(C-(x??C))/1e3;x=C,m!==0&&(b(j(C)),y.compute(m),W.render())};requestAnimationFrame(P)};te();
